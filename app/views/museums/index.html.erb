<table>
  <tr>
    <th></th>
    <th>所在地</th>
    <th colspan="2">施設名</th>
    <th>ジャンル</th>
    <th>訪問人数</th>
    <th>おすすめ</th>
    <th>コメント数</th>
    <th>写真数</th>
    <th><%= link_to '＋', new_museum_path %></th>
  </tr>
  <% @museums.each do |museum| %>
  <tr>
    <td>
      <% if user_signed_in? %>
        <% if museum.recommended_by?(current_user) %>
          ☆
        <% elsif museum.visited_by?(current_user) %>
          👨
        <% end %>
      <% end %>
    </td>
    <td><%= museum.prefecture %></td>
    <td><%= attachment_image_tag museum, :appearance_image, size:"40x40", format:"jpeg" %></td>
    <td><%= link_to museum.name, museum_path(museum.id) %></td>
    <td><%= museum.genre.name %></td>
    <td><%= museum.visits.count %>人</td>
    <td><%= museum.recommends.count %>人</td>
    <td><%= museum.posts.count %>件</td>
    <td>
      <% sum = 0 %>
      <% museum.posts.each do |post| %>
        <% sum += post.post_images.count %>
      <% end %>
      <%= sum %> 枚
    </td>
  </tr>
  <% end %>
</table>


<!--地図表示-->
<div id='map'></div>
  <style>
    #map {
      height: 500px ;
      width: 500px ;
    }
  </style>
<script>
  let map
    function initMap(){
      geocoder = new google.maps.Geocoder()

      map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 38.258595, lng:137.6850225},
          zoom: 5,
      });

      <% @museums.each do |m| %>
          (function(){
          var contentString = "<%= m.name %>";

          var marker = new google.maps.Marker({
              position:{lat: <%= m.latitude %>, lng: <%= m.longitude %>},
              map: map,
              title: contentString
          });
          // 情報ウィンドウ(吹き出し)の定義
          // 投稿の詳細ページへのリンクも
          var infowindow = new google.maps.InfoWindow({
          position: {lat: <%= m.latitude %>, lng: <%= m.longitude %>},
          content: contentString
          });
          // クリックしたときに情報ウィンドウを表示
          marker.addListener('click', function() {
          infowindow.open(map, marker);
          });
          })();
      <% end %>
      }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['API_KEY']%>&callback=initMap" async defer></script>