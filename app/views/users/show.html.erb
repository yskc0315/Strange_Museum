<div class="page-title">
  <% if @user.is_deleted == false %>
    <% if @user != current_user %>
      <h3><i class="fas fa-child"> <%= @user.name %>さんのページ</i></h3>
    <% else %>
      <h3><i class="fas fa-child"> マイページ</i></h3>
    <% end %>
</div>

<div class="row">
  <div class="col-md-3">
    <!--ユーザー詳細画面のサイドバー：基本情報を表示-->
    <table>
      <tr align="center">
        <th colspan="2"><%= attachment_image_tag @user, :profile_image, size:"80x80", format:"jpeg", fallback:"no_image.png", class:"circle-image" %></th>
        <th></th>
      </tr>
      <tr align="center">
        <th colspan="2"><%= @user.name %></th>
        <th></th>
      </tr>
      <tr>
        <th>　</th>
        <td>　</td>
      </tr>
      <tr>
        <th>行った博物館</th>
        <td>　<%= @user.visits.count %> 件</td>
      </tr>
      <tr>
        <th>おすすめした博物館</th>
        <td>　<%= @user.recommends.count %> 件</td>
      </tr>
      <tr>
        <td>　</td>
        <td>　</td>
      </tr>
      <% if @user.introduction != nil %>
        <tr align="center">
          <th colspan="2">自己紹介</th>
          <td></td>
        </tr>
      <% end %>
      <tr>
        <td colspan="2"><%= @user.introduction %></td>
        <td></td>
      </tr>
      <% if @user.forums.present? %>
        <% @user.forums.each do |forum| %>
          <% if forum.user_id == current_user.id %>
            <tr align="center">
              <th colspan="2">掲示板への投稿</th>
              <td></td>
            </tr>
            <tr>
              <td colspan="2">・
                <%= link_to forum.title, forum_path(forum.id) %>
              </td>
              <td></td>
            </tr>
          <% end %>
        <% end %>
      <% end %>
      <% if @user.id == current_user.id %>
        <tr align="center">
          <th colspan="2">参加中の掲示板</th>
          <td></td>
        </tr>
        <% @forums.each do |forum| %>
          <tr>
            <td colspan="2">・
              <%= link_to forum.forum.title, forum_path(forum.id) %>
            </td>
            <td></td>
          </tr>
        <% end %>
      <% end %>
      <tr align="center">
        <th colspan="2">
          <% if @user != current_user %>
            <% if @user.followed_by?(current_user) %>
              <%= link_to 'フォロー中', user_relation_path(@user.id, @user.id), method: :delete, class:"btn btn-success" %>
            <% else %>
              <%= link_to 'フォロー', user_relations_path(@user.id), method: :post, class:"btn btn-primary" %>
            <% end %>
          <% end %>
        </th>
        <td></td>
      </tr>
      <tr>
        <td>　</td>
        <td>　</td>
      </tr>
      <% if @user == current_user %>
        <tr align="center">
          <th colspan="2">
            <%= link_to edit_user_path(current_user), class:"btn btn-outline-success btn-block" do %>
              <i class="fas fa-user-edit"></i>
              編集
            <% end %>
          </th>
          <td></td>
        </tr>
        <tr>
          <td>　</td>
        </tr>
        <tr align="center">
          <th colspan="2">
            <%= link_to user_withdraw_path(current_user), method: :put, "data-confirm" => "本当に退会しますか？", class:"btn btn-outline-danger" do %>
              <i class="fas fa-running"></i>
              退会
            <% end %>
          </th>
        </tr>
      <% end %>
    </table>
  </div>

  <div class="col-md-9 wrap">
    <% if @user == current_user %>
      <ul id="tab-menu" class="mb-0">
        <li><a href="#top" class="active">お知らせ</a></li>
        <li><a href="#visit-museum" class="">行った博物館</a></li>
        <li><a href="#post" class="">投稿</a></li>
        <li><a href="#post-image" class="">アルバム</a></li>
        <li><a href="#follow" class="">フォロー</a></li>
      </ul>
    <% else %>
      <ul id="tab-menu" class="mb-0">
        <li><a href="#top" class="active">行った博物館</a></li>
        <li><a href="#post" class="">投稿</a></li>
        <li><a href="#post-image" class="">アルバム</a></li>
        <li><a href="#follow" class="">フォロー</a></li>
      </ul>
    <% end %>
    <div id="tab-contents">
      <!--自分以外のユーザーには通知が見えないように-->
      <% if @user == current_user %>
        <div id="top" class="tab">
          <!--各種通知表示-->
          <h4><strong>新着博物館</strong></h4>
          <div class="mb-5">
            <h5>　登録</h5>
            <% @created_museums.each do |museum| %>
              <% if user_signed_in? %>
                <table>
                  <tr><%= museum.created_at.strftime('%Y/%m/%d') %></tr>
                  <tr>
                    <%= link_to user_path(museum.user.id) do %>
                      <% if museum.user.is_deleted == false %>
                        <%= museum.user.name %>さん
                      <% else %>
                        <span>退会済みユーザー</span>
                      <% end %>
                    <% end %>
                    が
                  </tr>
                  <tr><%= link_to museum.name, museum_path(museum.id) %>を投稿しました！</tr>
                </table>
              <% end %>
            <% end %>
            <h5 class="mt-2">　編集</h5>
            <% @updated_museums.each do |museum| %>
              <% if user_signed_in? %>
                <table>
                  <tr><%= museum.created_at.strftime('%Y/%m/%d') %></tr>
                  <tr>
                    <%= link_to user_path(museum.user.id) do %>
                      <% if museum.user.is_deleted == false %>
                        <%= museum.user.name %>さん
                      <% else %>
                        <span>退会済みユーザー</span>
                      <% end %>
                    <% end %>
                    が
                  </tr>
                  <tr><%= link_to museum.name, museum_path(museum.id) %>を編集しました！</tr>
                </table>
              <% end %>
            <% end %>
          </div>
          <h4><strong>その他</strong></h4>
            <% notifications = @notifications.where.not(visitor_id: current_user.id) %>
            <% if notifications.exists? %>
              <%= render notifications %>
            <% else %>
              <p>通知はありません</p>
            <% end %>
        </div>
      <% end %>

      <% if @user == current_user %>
        <div id="visit-museum" class="tab">
      <% else %>
        <div id="top" class="tab">
      <% end %>
        <!--行った：訪問済み(行ったボタンを押した)施設の一覧表示-->
        <table class="table visited-museum">
          <tr align="center">
            <th></th>
            <th></th>
            <th></th>
            <th>所在県</th>
            <th>ジャンル</th>
            <th>訪問人数</th>
            <th>おすすめ</th>
            <th>コメント数</th>
            <th>写真数</th>
          </tr>
          <% @museums.each do |museum| %>
            <% if museum.visited_by?(@user) %>
            <tr align="center">
              <td>
                <% if museum.recommended_by?(@user) %>
                  <i class="fas fa-star star"></i>
                <% elsif museum.visited_by?(current_user) %>
                  <i class="fas fa-door-open door"></i>
                <% end %>
              </td>
              <td><%= attachment_image_tag museum, :appearance_image, size:"40x40", format:"jpeg" %></td>
              <td align="left" class="visited-museum-name">
                <%= link_to museum_path(museum.id) do %>
                  　<%= museum.name %>
                <% end %>
              </td>
              <td><%= museum.prefecture %></td>
              <td><%= museum.genre.name %></td>
              <td><%= museum.visits.count %> 人</td>
              <td><%= museum.recommends.count %> 人</td>
              <td><%= museum.posts.count %> 件</td>
              <td><%= museum.post_images.count %> 枚</td>
            </tr>
            <% end %>
          <% end %>
        </table>
      </div>

      <div id="post" class="tab">
        <!--コメント：コメントの一覧表示-->
        <% @posts.each do |post| %>
          <div class="post-index">
            <% if post.user.is_deleted == false %>
              <div class="post-title d-flex">
                <div class="post-main_title">
                  <strong><%= post.title %></strong>
                  <span>
                    　<%= link_to museum_path(post.museum.id) do %>
                    　 ＠<%= post.museum.name %>
                    　<% end %>
                  </span>
                </div>
                <div class="post-user">
                  <%= link_to user_path(post.user.id) do %>
                    <%= attachment_image_tag post.user, :profile_image, size:"40x40", format:"jpeg", fallback:"no_image.png", class:"circle-image" %>
                  <% end %>
                  <%= post.user.name %>
                </div>
              </div>
              <div class="post-body">
                <%= post.body %><br/>
                <!--画像が投稿されていた場合に画像表示-->
                <% if post.post_images.present? %>
                  <% post.post_images.each do |image| %>
                    <%= attachment_image_tag image, :picture, size:"40x40", format:"jpeg" %>
                  <% end %>
                <% end %>
              </div>
              <div class="post-detail d-flex">
                <div>
                  <% if post.how_to_visit.present? %>
                    <label>訪問方法：</label>
                    <%= post.how_to_visit %>
                  <% end %>
                  <% if post.companion.present? %>
                    <label>同伴者：</label>
                    <%= post.companion %>
                  <% end %>
                </div>
                <div>
                  <% if post.user == current_user %>
                    <%= link_to edit_museum_post_path(post.museum.id, post.id) do %>
                      <i class="far fa-edit fa-lg"></i>
                      編集
                    <% end %>
                    <%= link_to museum_post_path(post.museum.id, post.id), method: :delete do %>
                      <i class="far fa-trash-alt fa-lg"></i>
                      削除
                    <% end %>
                  <% else %>
                    <% if post.favorited_by?(current_user) %>
                      <%= link_to museum_post_favorite_path(post.museum.id, post.id, post.id), method: :delete do %>
                        <i class="fas fa-heart fa-lg"></i>
                        <%= post.favorites.count %>
                      <% end %>
                    <% else %>
                      <%= link_to museum_post_favorites_path(post.museum.id, post.id), method: :post do %>
                        <i class="far fa-heart fa-lg"></i>
                        <%= post.favorites.count %>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <div id="post-image" class="tab">
        <!--アルバム：投稿された写真の一覧表示-->
        <% @museums.each do |museum| %>
          <% museum.posted_by(@user).each do |post| %>
            <% if post.post_images.exists? %>
              <h4 class="mb-2"><%= post.museum.name %></h4><br/>
              <% post.post_images.each do |image| %>
                <%= attachment_image_tag image, :picture, size:"100x100", format:"jpeg" %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      </div>

      <div id="follow" class="tab">
        <!--フォロー・フォロワー：フォローしている人、されている人の一覧表示-->
        <div>
          <div>
            <h5><strong>フォロー</strong></h5>
            <table class="table">
              <tr align="center">
                <th></th>
                <th></th>
                <th>訪問軒数</th>
                <th>おすすめ</th>
                <th>コメント数</th>
                <th>写真数</th>
              </tr>
              <% @followings.each do |following| %>
              <tr align="center">
                <td><%= attachment_image_tag following, :profile_image, size:"40x40", format:"jpeg", fallback:"no_image.png" %></td>
                <td><%= following.name %></td>
                <td><%= following.visits.count %> 軒</td>
                <td><%= following.recommends.count %> 軒</td>
                <td><%= following.posts.count %> 件</td>
                <td><%= following.post_images.count %> 枚</td>
              </tr>
              <% end %>
            </table>
          </div>
          <div>
            <h5><strong>フォロワー</strong></h5>
            <table class="table">
              <tr align="center">
                <th></th>
                <th></th>
                <th>訪問軒数</th>
                <th>おすすめ</th>
                <th>コメント数</th>
                <th>写真数</th>
              </tr>
              <% @followeds.each do |followed| %>
              <tr align="center">
                <td><%= attachment_image_tag followed, :profile_image, size:"40x40", format:"jpeg", fallback:"no_image.png" %></td>
                <td><%= followed.name %></td>
                <td><%= followed.visits.count %> 軒</td>
                <td><%= followed.recommends.count %> 軒</td>
                <td><%= followed.posts.count %> 件</td>
                <td><%= followed.post_images.count %> 枚</td>
              </tr>
              <% end %>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!--<script src="assets/javascripts/jquery.min.js"></script>-->
    <script defer="application.js"></script>
  </div>
</div>
<% else %>
  <h3>ページが存在しません！</h3>
<% end %>
